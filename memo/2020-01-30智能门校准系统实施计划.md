# SmartPen æ™ºèƒ½é—¨æ ¡å‡†ç³»ç»Ÿ - å®æ–½è®¡åˆ’

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:subagent-driven-development to implement this plan task-by-task.

**ç›®æ ‡:** å®ç°å››çº§åé¦ˆç³»ç»Ÿä¸æ™ºèƒ½é—¨æŒ‰é’®ï¼Œç¡®ä¿ç”¨æˆ·åœ¨æ­£ç¡®å§¿æ€å’Œæ‰‹éƒ¨å¯è§çš„æƒ…å†µä¸‹æ‰èƒ½å¼€å§‹ç»ƒä¹ ã€‚

**æ¶æ„:** æ‰©å±•ç°æœ‰ Pose Detector æ”¯æŒ wrist landmarks â†’ æ–°å¢ CalibrationStateManager ç®¡ç†ç¨³å®šçŠ¶æ€ â†’ UI å®ç°å››æ€åé¦ˆã€‚

**æŠ€æœ¯æ ˆ:** Flutter, ML Kit Pose Detection (Base æ¨¡å‹), Provider çŠ¶æ€ç®¡ç†, Timer ç¨³å®šæ€§æ£€æµ‹ã€‚

---

## ç”¨æˆ·ç¡®è®¤çš„å®ç°æ–¹å¼

- **æ‰‹éƒ¨æ£€æµ‹å®¹é”™:** 1 ç§’ç¼“å†²æœŸï¼ˆçŸ­æš‚æ¶ˆå¤±ä¸è§¦å‘è­¦å‘Šï¼‰
- **äººè„¸æ£€æµ‹æ–¹å¼:** ç®€åŒ–æ£€æµ‹ï¼ˆæ£€æŸ¥ Pose nose landmark æ˜¯å¦ä¸º nullï¼‰
- **å¯ç”¨æŒ‰é’®æ¡ä»¶:** æ ¸å¿ƒäºŒæ¡ä»¶ï¼ˆå§¿æ€æ­£ç¡® AND æœ‰æ‰‹éƒ¨å¯è§ï¼‰æŒç»­ 1 ç§’

---

## Task 1: æ‰©å±•æ•°æ®æ¨¡å‹

**ç›®æ ‡:** æ·»åŠ æ ¡å‡†çŠ¶æ€æšä¸¾å’Œæ‰©å±• PostureAnalysis æ”¯æŒæ‰‹éƒ¨/äººè„¸æ£€æµ‹ã€‚

**Files:**
- Modify: `/Users/Zhuanz/Documents/01_SmartPen/smartpen-project/frontend/lib/services/posture_data.dart`

### Step 1: æ·»åŠ  CalibrationState æšä¸¾

åœ¨ `posture_data.dart` æ–‡ä»¶æœ«å°¾ï¼ˆ`PostureDetector` ç±»ä¹‹åï¼‰æ·»åŠ ï¼š

```dart
/// æ ¡å‡†çŠ¶æ€æšä¸¾
enum CalibrationState {
  noFace,      // æ— äººè„¸ - çº¢è‰²
  badPosture,  // å§¿æ€ä¸ä½³ - æ©™è‰²
  noHands,     // æ— æ‰‹éƒ¨ - æ©™è‰²
  aligned,     // å¯¹é½å®Œæˆ - ç»¿è‰²
}

/// æ ¡å‡†çŠ¶æ€æ‰©å±•æ–¹æ³•
extension CalibrationStateExtension on CalibrationState {
  String get message {
    switch (this) {
      case CalibrationState.noFace:
        return 'No face detected';
      case CalibrationState.badPosture:
        return 'Sit up straight';
      case CalibrationState.noHands:
        return 'Show your hand';
      case CalibrationState.aligned:
        return 'Perfect!';
    }
  }

  Color get color {
    switch (this) {
      case CalibrationState.noFace:
        return Colors.red;
      case CalibrationState.badPosture:
        return Colors.orange;
      case CalibrationState.noHands:
        return Colors.orange;
      case CalibrationState.aligned:
        return Colors.green;
    }
  }

  bool get isReadyForPractice {
    return this == CalibrationState.aligned;
  }

  String get name => toString().split('.').last;
}
```

### Step 2: æ‰©å±• PostureAnalysis ç±»

åœ¨ `PostureAnalysis` ç±»ä¸­æ·»åŠ æ–°å­—æ®µå’Œ getterï¼š

```dart
// åœ¨ PostureAnalysis ç±»é¡¶éƒ¨æ·»åŠ æ–°å­—æ®µ
final bool hasVisibleHands;  // æ˜¯å¦æ£€æµ‹åˆ°æ‰‹éƒ¨
final bool isFaceDetected;   // æ˜¯å¦æ£€æµ‹åˆ°äººè„¸

// æ›´æ–°æ„é€ å‡½æ•°
PostureAnalysis({
  required this.isCorrect,
  required this.spineAngle,
  required this.eyeScreenDistance,
  required this.headTiltAngle,
  required this.isSpineCorrect,
  required this.isDistanceCorrect,
  required this.isHeadCorrect,
  required this.feedback,
  this.hasVisibleHands = false,  // æ–°å¢ï¼Œé»˜è®¤ false
  this.isFaceDetected = false,   // æ–°å¢ï¼Œé»˜è®¤ false
});

// æ·»åŠ æ ¡å‡†çŠ¶æ€ getter
CalibrationState get calibrationState {
  if (!isFaceDetected) {
    return CalibrationState.noFace;
  }
  if (!isCorrect) {
    return CalibrationState.badPosture;
  }
  if (!hasVisibleHands) {
    return CalibrationState.noHands;
  }
  return CalibrationState.aligned;
}

// æ›´æ–° toString æ–¹æ³•
@override
String toString() {
  return 'PostureAnalysis(spine: ${spineAngle.toStringAsFixed(1)}Â°, '
      'distance: ${eyeScreenDistance.toStringAsFixed(1)}cm, '
      'tilt: ${headTiltAngle.toStringAsFixed(1)}Â°, '
      'correct: $isCorrect, '
      'hands: $hasVisibleHands, '
      'face: $isFaceDetected)';
}
```

**è¿è¡Œæµ‹è¯•éªŒè¯ç¼–è¯‘:**
```bash
cd /Users/Zhuanz/Documents/01_SmartPen/smartpen-project/frontend
flutter analyze lib/services/posture_data.dart
```
é¢„æœŸ: æ— é”™è¯¯

### Step 3: æäº¤

```bash
git add lib/services/posture_data.dart
git commit -m "feat: æ·»åŠ æ ¡å‡†çŠ¶æ€æšä¸¾å’Œæ‰©å±• PostureAnalysis

- æ–°å¢ CalibrationState æšä¸¾ï¼ˆnoFace, badPosture, noHands, alignedï¼‰
- æ·»åŠ çŠ¶æ€æ‰©å±•æ–¹æ³•ï¼ˆmessage, color, isReadyForPracticeï¼‰
- PostureAnalysis æ–°å¢ hasVisibleHands å’Œ isFaceDetected å­—æ®µ
- æ·»åŠ  calibrationState getter ç”¨äºå››çº§çŠ¶æ€åˆ¤æ–­"
```

---

## Task 2: åˆ›å»ºæ ¡å‡†çŠ¶æ€ç®¡ç†å™¨

**ç›®æ ‡:** å®ç° 1 ç§’ç¨³å®šæ€§æ£€æµ‹å’Œ 1 ç§’æ‰‹éƒ¨ç¼“å†²æœŸé€»è¾‘ã€‚

**Files:**
- Create: `/Users/Zhuanz/Documents/01_SmartPen/smartpen-project/frontend/lib/services/calibration_state_manager.dart`

### Step 1: ç¼–å†™å¤±è´¥çš„æµ‹è¯• - ç¨³å®šæ€§è®¡æ—¶å™¨

```dart
// test/services/calibration_state_manager_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:smartpen_frontend/services/calibration_state_manager.dart';
import 'package:smartpen_frontend/services/posture_data.dart';

void main() {
  group('CalibrationStateManager', () {
    test('åˆå§‹çŠ¶æ€åº”ä¸º noFace ä¸”æœªå°±ç»ª', () {
      final manager = CalibrationStateManager();
      expect(manager.currentState, CalibrationState.noFace);
      expect(manager.isReadyForPractice, false);
    });

    test('æ”¶åˆ° aligned çŠ¶æ€åä¸ç«‹å³å°±ç»ª', () async {
      final manager = CalibrationStateManager();

      // åˆ›å»ºä¸€ä¸ª aligned çŠ¶æ€çš„åˆ†æç»“æœ
      final analysis = PostureAnalysis(
        isCorrect: true,
        spineAngle: 10.0,
        eyeScreenDistance: 40.0,
        headTiltAngle: 5.0,
        isSpineCorrect: true,
        isDistanceCorrect: true,
        isHeadCorrect: true,
        feedback: 'åå§¿è‰¯å¥½',
        hasVisibleHands: true,
        isFaceDetected: true,
      );

      manager.processAnalysis(analysis);

      // ç«‹å³æ£€æŸ¥ï¼Œåº”è¯¥æœªå°±ç»ªï¼ˆéœ€è¦ç­‰å¾… 1 ç§’ï¼‰
      expect(manager.isReadyForPractice, false);
    });

    test('æ”¶åˆ° aligned çŠ¶æ€ 1 ç§’åå°±ç»ª', () async {
      final manager = CalibrationStateManager();

      final analysis = PostureAnalysis(
        isCorrect: true,
        spineAngle: 10.0,
        eyeScreenDistance: 40.0,
        headTiltAngle: 5.0,
        isSpineCorrect: true,
        isDistanceCorrect: true,
        isHeadCorrect: true,
        feedback: 'åå§¿è‰¯å¥½',
        hasVisibleHands: true,
        isFaceDetected: true,
      );

      manager.processAnalysis(analysis);

      // ç­‰å¾… 1.1 ç§’
      await Future.delayed(const Duration(milliseconds: 1100));

      expect(manager.isReadyForPractice, true);
      expect(manager.lastStableState, CalibrationState.aligned);
    });

    test('æ‰‹éƒ¨çŸ­æš‚æ¶ˆå¤±ä¸è§¦å‘è­¦å‘Šï¼ˆç¼“å†²æœŸï¼‰', () async {
      final manager = CalibrationStateManager();

      // å…ˆå‘é€æœ‰æ‰‹éƒ¨çš„æ•°æ®
      final goodAnalysis = PostureAnalysis(
        isCorrect: true,
        spineAngle: 10.0,
        eyeScreenDistance: 40.0,
        headTiltAngle: 5.0,
        isSpineCorrect: true,
        isDistanceCorrect: true,
        isHeadCorrect: true,
        feedback: 'åå§¿è‰¯å¥½',
        hasVisibleHands: true,
        isFaceDetected: true,
      );

      manager.processAnalysis(goodAnalysis);
      await Future.delayed(const Duration(milliseconds: 1100));
      expect(manager.isReadyForPractice, true);

      // å‘é€æ— æ‰‹éƒ¨æ•°æ®
      final noHandAnalysis = PostureAnalysis(
        isCorrect: true,
        spineAngle: 10.0,
        eyeScreenDistance: 40.0,
        headTiltAngle: 5.0,
        isSpineCorrect: true,
        isDistanceCorrect: true,
        isHeadCorrect: true,
        feedback: 'åå§¿è‰¯å¥½',
        hasVisibleHands: false,
        isFaceDetected: true,
      );

      manager.processAnalysis(noHandAnalysis);

      // ç«‹å³æ£€æŸ¥ï¼Œåº”è¯¥ä»åœ¨ç¼“å†²æœŸï¼Œä¿æŒå°±ç»ªçŠ¶æ€
      expect(manager.currentState, CalibrationState.aligned);
    });
  });
}
```

**è¿è¡Œæµ‹è¯•éªŒè¯å¤±è´¥:**
```bash
flutter test test/services/calibration_state_manager_test.dart
```
é¢„æœŸ: FAIL - "CalibrationStateManager class not found"

### Step 2: å®ç° CalibrationStateManager ç±»

```dart
// lib/services/calibration_state_manager.dart
import 'dart:async';
import 'package:flutter/foundation.dart';
import 'posture_data.dart';

/// æ ¡å‡†çŠ¶æ€ç®¡ç†å™¨
///
/// è´Ÿè´£ï¼š
/// 1. ç®¡ç†ç¨³å®šæ£€æµ‹è®¡æ—¶å™¨ï¼ˆ1ç§’è¦æ±‚ï¼‰
/// 2. æ‰‹éƒ¨æ£€æµ‹ç¼“å†²æœŸï¼ˆ1ç§’å®¹é”™ï¼‰
/// 3. å†³å®šæ˜¯å¦å¯ç”¨"å¼€å§‹ç»ƒä¹ "æŒ‰é’®
class CalibrationStateManager extends ChangeNotifier {
  CalibrationState _currentState = CalibrationState.noFace;
  CalibrationState _lastStableState = CalibrationState.noFace;

  Timer? _stabilityTimer;
  DateTime? _handLastSeenTime;
  bool _isHandBufferActive = false;

  static const Duration _stabilityThreshold = Duration(seconds: 1);
  static const Duration _handBufferDuration = Duration(seconds: 1);

  CalibrationState get currentState => _currentState;
  CalibrationState get lastStableState => _lastStableState;
  bool get isReadyForPractice => _lastStableState == CalibrationState.aligned;

  /// å¤„ç†æ–°çš„å§¿æ€åˆ†æç»“æœ
  void processAnalysis(PostureAnalysis analysis) {
    final newState = analysis.calibrationState;

    debugPrint('ğŸ¯ CalibrationState: ${_currentState} -> $newState');
    debugPrint('ğŸ–ï¸  Has hands: ${analysis.hasVisibleHands}, '
        'Face: ${analysis.isFaceDetected}');

    _handleHandDetectionBuffer(analysis);
    _handleStabilityTimer(newState, analysis);

    _currentState = newState;
    notifyListeners();
  }

  /// æ‰‹éƒ¨æ£€æµ‹ç¼“å†²æœŸå¤„ç†
  /// é¿å…æ‰‹éƒ¨çŸ­æš‚æ¶ˆå¤±å¯¼è‡´è¯¯æŠ¥
  void _handleHandDetectionBuffer(PostureAnalysis analysis) {
    if (analysis.hasVisibleHands) {
      // æ£€æµ‹åˆ°æ‰‹éƒ¨ï¼Œè®°å½•æ—¶é—´
      _handLastSeenTime = DateTime.now();
      _isHandBufferActive = false;
    } else if (_handLastSeenTime != null) {
      // æœªæ£€æµ‹åˆ°æ‰‹éƒ¨ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨ç¼“å†²æœŸå†…
      final timeSinceLastSeen = DateTime.now().difference(_handLastSeenTime!);

      if (timeSinceLastSeen < _handBufferDuration) {
        _isHandBufferActive = true;
        debugPrint('â³ Hand buffer active: '
            '${timeSinceLastSeen.inMilliseconds}ms / ${_handBufferDuration.inMilliseconds}ms');
      } else {
        _isHandBufferActive = false;
        _handLastSeenTime = null;
      }
    }
  }

  /// ç¨³å®šæ€§è®¡æ—¶å™¨å¤„ç†
  /// åªæœ‰åœ¨ aligned çŠ¶æ€æŒç»­1ç§’åæ‰çœŸæ­£å¯ç”¨æŒ‰é’®
  void _handleStabilityTimer(CalibrationState newState, PostureAnalysis analysis) {
    // æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ ¸å¿ƒäºŒæ¡ä»¶ï¼ˆå§¿æ€æ­£ç¡® + æœ‰æ‰‹éƒ¨ï¼‰
    // æ³¨æ„ï¼šåœ¨æ‰‹éƒ¨ç¼“å†²æœŸå†…ï¼Œè®¤ä¸ºæ‰‹éƒ¨å­˜åœ¨
    final hasGoodPosture = analysis.isCorrect;
    final hasHand = analysis.hasVisibleHands || _isHandBufferActive;

    if (hasGoodPosture && hasHand) {
      // æ»¡è¶³æ¡ä»¶ï¼Œå¯åŠ¨æˆ–ç»§ç»­è®¡æ—¶
      if (_stabilityTimer == null || !_stabilityTimer!.isActive) {
        debugPrint('â±ï¸  Starting stability timer...');
        _stabilityTimer?.cancel();
        _stabilityTimer = Timer(_stabilityThreshold, () {
          debugPrint('âœ… Stability threshold reached!');
          _lastStableState = CalibrationState.aligned;
          notifyListeners();
        });
      }
    } else {
      // æ¡ä»¶ä¸æ»¡è¶³ï¼Œå–æ¶ˆè®¡æ—¶
      if (_stabilityTimer != null && _stabilityTimer!.isActive) {
        debugPrint('âŒ Stability condition broken, cancelling timer');
        _stabilityTimer?.cancel();
        _lastStableState = newState;
      }
    }
  }

  /// é‡ç½®çŠ¶æ€ï¼ˆç”¨äºé‡æ–°è¿›å…¥æ ¡å‡†æ¨¡å¼ï¼‰
  void reset() {
    _stabilityTimer?.cancel();
    _handLastSeenTime = null;
    _isHandBufferActive = false;
    _currentState = CalibrationState.noFace;
    _lastStableState = CalibrationState.noFace;
    notifyListeners();
  }

  @override
  void dispose() {
    _stabilityTimer?.cancel();
    super.dispose();
  }
}
```

### Step 3: è¿è¡Œæµ‹è¯•éªŒè¯é€šè¿‡

```bash
flutter test test/services/calibration_state_manager_test.dart
```
é¢„æœŸ: PASS (4 tests)

### Step 4: æäº¤

```bash
git add lib/services/calibration_state_manager.dart test/services/calibration_state_manager_test.dart
git commit -m "feat: å®ç°æ ¡å‡†çŠ¶æ€ç®¡ç†å™¨

- å®ç° 1 ç§’ç¨³å®šæ€§è®¡æ—¶å™¨ï¼ˆaligned çŠ¶æ€æŒç»­ 1 ç§’åå¯ç”¨æŒ‰é’®ï¼‰
- å®ç° 1 ç§’æ‰‹éƒ¨ç¼“å†²æœŸï¼ˆé¿å…çŸ­æš‚æ¶ˆå¤±è¯¯æŠ¥ï¼‰
- æ ¸å¿ƒäºŒæ¡ä»¶åˆ¤æ–­ï¼šå§¿æ€æ­£ç¡® AND æœ‰æ‰‹éƒ¨å¯è§
- æ·»åŠ å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–"
```

---

## Task 3: æ›´æ–° PostureDetector æ”¯æŒæ‰‹éƒ¨æ£€æµ‹

**ç›®æ ‡:** åœ¨å§¿æ€æ£€æµ‹ä¸­æ·»åŠ äººè„¸å’Œæ‰‹éƒ¨æ£€æµ‹é€»è¾‘ã€‚

**Files:**
- Modify: `/Users/Zhuanz/Documents/01_SmartPen/smartpen-project/frontend/lib/services/posture_detector.dart`

### Step 1: æ·»åŠ æ‰‹éƒ¨æ£€æµ‹æ–¹æ³•

åœ¨ `PostureDetector` ç±»ä¸­æ·»åŠ æ–°æ–¹æ³•ï¼š

```dart
/// æ–°å¢ï¼šæ£€æµ‹æ˜¯å¦æœ‰å¯è§çš„æ‰‹éƒ¨
/// é€šè¿‡æ£€æŸ¥ wrist landmarks åˆ¤æ–­
static bool _hasVisibleHands(Pose pose) {
  final leftWrist = pose.landmarks[PoseLandmarkType.leftWrist];
  final rightWrist = pose.landmarks[PoseLandmarkType.rightWrist];

  // è‡³å°‘æ£€æµ‹åˆ°ä¸€ä¸ªæ‰‹è…•ï¼Œä¸”ç½®ä¿¡åº¦è¶³å¤Ÿé«˜
  final minConfidence = 0.5;
  final leftValid = leftWrist != null && leftWrist.likelihood > minConfidence;
  final rightValid = rightWrist != null && rightWrist.likelihood > minConfidence;

  return leftValid || rightValid;
}

/// æ–°å¢ï¼šæ£€æµ‹æ˜¯å¦æœ‰äººè„¸
/// é€šè¿‡æ£€æŸ¥ nose landmark åˆ¤æ–­
static bool _hasFaceDetected(Pose pose) {
  final nose = pose.landmarks[PoseLandmarkType.nose];
  return nose != null && nose.likelihood > 0.3;
}
```

### Step 2: æ›´æ–° analyzePose æ–¹æ³•

ä¿®æ”¹ç°æœ‰çš„ `analyzePose` æ–¹æ³•ï¼Œæ·»åŠ æ–°é€»è¾‘ï¼š

```dart
/// åˆ†æå§¿æ€æ•°æ®ï¼ˆæ‰©å±•ç‰ˆï¼‰
static PostureAnalysis analyzePose(Pose pose) {
  // è®¡ç®—å„é¡¹æŒ‡æ ‡
  final spineAngle = _calculateSpineAngle(pose);
  final eyeScreenDistance = _estimateEyeScreenDistance(pose);
  final headTilt = _calculateHeadTilt(pose);

  // åˆ¤æ–­æ˜¯å¦æ­£ç¡®
  final isSpineCorrect = spineAngle != null && spineAngle < maxSpineAngle;
  final isDistanceCorrect = eyeScreenDistance != null &&
      eyeScreenDistance >= minEyeScreenDistance;
  final isHeadCorrect = headTilt != null && headTilt.abs() < maxHeadTilt;

  final isCorrect = isSpineCorrect && isDistanceCorrect && isHeadCorrect;

  // ========== æ–°å¢ï¼šäººè„¸å’Œæ‰‹éƒ¨æ£€æµ‹ ==========
  final isFaceDetected = _hasFaceDetected(pose);
  final hasVisibleHands = _hasVisibleHands(pose);

  return PostureAnalysis(
    isCorrect: isCorrect,
    spineAngle: spineAngle ?? 0.0,
    eyeScreenDistance: eyeScreenDistance ?? 0.0,
    headTiltAngle: headTilt ?? 0.0,
    isSpineCorrect: isSpineCorrect,
    isDistanceCorrect: isDistanceCorrect,
    isHeadCorrect: isHeadCorrect,
    feedback: _generateFeedback(
      spineAngle: spineAngle,
      eyeScreenDistance: eyeScreenDistance,
      headTilt: headTilt,
      hasVisibleHands: hasVisibleHands,
    ),
    // æ–°å¢å­—æ®µ
    hasVisibleHands: hasVisibleHands,
    isFaceDetected: isFaceDetected,
  );
}
```

### Step 3: æ›´æ–° _generateFeedback æ–¹æ³•ç­¾å

æ·»åŠ å¯é€‰çš„ `hasVisibleHands` å‚æ•°ï¼š

```dart
/// ç”Ÿæˆåé¦ˆä¿¡æ¯
static String _generateFeedback({
  required double? spineAngle,
  required double? eyeScreenDistance,
  required double? headTilt,
  bool? hasVisibleHands,  // æ–°å¢å‚æ•°
}) {
  final issues = <String>[];

  if (spineAngle != null && spineAngle >= maxSpineAngle) {
    issues.add('è¯·åç›´ï¼Œèº«ä½“ä¿æŒæ­£ç›´');
  }

  if (eyeScreenDistance != null && eyeScreenDistance < minEyeScreenDistance) {
    issues.add('è¯·ä¿æŒé€‚å½“è·ç¦»ï¼Œçœ¼ç›ç¦»å±å¹•å¤ªè¿‘');
  }

  if (headTilt != null && headTilt.abs() >= maxHeadTilt) {
    issues.add('è¯·ä¿æŒå¤´éƒ¨æ­£ç›´ï¼Œä¸è¦æ­ªå¤´');
  }

  // æ³¨æ„ï¼šæ‰‹éƒ¨æç¤ºç”± CalibrationState çš„ message å¤„ç†
  // è¿™é‡Œä¿ç•™ä¼ ç»Ÿçš„åé¦ˆé€»è¾‘

  if (issues.isEmpty) {
    return 'åå§¿è‰¯å¥½ï¼Œç»§ç»­ä¿æŒ';
  }

  return issues.join('ï¼›');
}
```

### Step 4: è¿è¡Œæµ‹è¯•éªŒè¯

```bash
flutter analyze lib/services/posture_detector.dart
```
é¢„æœŸ: æ— é”™è¯¯

### Step 5: æäº¤

```bash
git add lib/services/posture_detector.dart
git commit -m "feat: PostureDetector æ·»åŠ äººè„¸å’Œæ‰‹éƒ¨æ£€æµ‹

- æ·»åŠ  _hasVisibleHands() æ–¹æ³•ï¼ˆæ£€æŸ¥ wrist landmarksï¼‰
- æ·»åŠ  _hasFaceDetected() æ–¹æ³•ï¼ˆæ£€æŸ¥ nose landmarkï¼‰
- æ›´æ–° analyzePose() è¿”å›æ‰©å±•çš„ PostureAnalysis
- ä½¿ç”¨ 0.5 ç½®ä¿¡åº¦é˜ˆå€¼æ£€æµ‹æ‰‹éƒ¨ï¼Œ0.3 é˜ˆå€¼æ£€æµ‹äººè„¸"
```

---

## Task 4: æ›´æ–° PostureProvider é›†æˆæ ¡å‡†ç®¡ç†å™¨

**ç›®æ ‡:** åœ¨çŠ¶æ€ç®¡ç†ä¸­é›†æˆ CalibrationStateManagerã€‚

**Files:**
- Modify: `/Users/Zhuanz/Documents/01_SmartPen/smartpen-project/frontend/lib/providers/posture_provider.dart`

### Step 1: æ·»åŠ å¯¼å…¥å’Œå­—æ®µ

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```dart
import '../services/calibration_state_manager.dart';
```

åœ¨ `PostureProvider` ç±»ä¸­æ·»åŠ å­—æ®µï¼š

```dart
final CalibrationStateManager _calibrationManager = CalibrationStateManager();
```

### Step 2: æ·»åŠ æ ¡å‡†çŠ¶æ€è®¿é—®å™¨

åœ¨ Getters éƒ¨åˆ†æ·»åŠ ï¼š

```dart
// æ–°å¢ï¼šæ ¡å‡†çŠ¶æ€è®¿é—®å™¨
CalibrationState get calibrationState => _calibrationManager.currentState;
bool get isReadyForPractice => _calibrationManager.isReadyForPractice;
String get calibrationMessage => _calibrationManager.currentState.message;
Color get calibrationColor => _calibrationManager.currentState.color;
```

### Step 3: æ›´æ–° startMonitoring æ–¹æ³•

åœ¨å§¿æ€æµç›‘å¬ä¸­æ·»åŠ æ ¡å‡†çŠ¶æ€æ›´æ–°ï¼š

```dart
/// å¼€å§‹ç›‘æµ‹
void startMonitoring() {
  if (_isMonitoring) {
    debugPrint('âš ï¸  PostureProvider: å·²ç»åœ¨ç›‘æµ‹ä¸­ï¼Œè·³è¿‡');
    return;
  }

  debugPrint('ğŸ¯ PostureProvider: å¼€å§‹ç›‘æµ‹å§¿æ€...');
  _isMonitoring = true;

  // é‡ç½®æ ¡å‡†ç®¡ç†å™¨
  _calibrationManager.reset();

  // å–æ¶ˆæ—§è®¢é˜…
  _poseSubscription?.cancel();

  // è®¢é˜…å§¿æ€æµ
  _poseSubscription = _mlkitService.poseStream.listen(
    (poses) {
      _currentPoses = poses;

      // åˆ†æå§¿æ€
      if (poses.isNotEmpty) {
        _currentAnalysis = detector.PostureDetector.analyzePose(poses.first);

        // æ–°å¢ï¼šæ›´æ–°æ ¡å‡†çŠ¶æ€ç®¡ç†å™¨
        _calibrationManager.processAnalysis(_currentAnalysis!);

        debugPrint('ğŸ“Š Calibration: ${_currentAnalysis!.calibrationState}, '
            'Ready: $isReadyForPractice');
      }

      notifyListeners();
    },
    onError: (error) {
      debugPrint('âŒ PostureProvider: æµé”™è¯¯ - $error');
      _errorMessage = 'ç›‘æµ‹å‡ºé”™: $error';
      notifyListeners();
    },
  );

  notifyListeners();
  debugPrint('âœ… PostureProvider: å§¿æ€ç›‘æµ‹å·²å¯åŠ¨');
}
```

### Step 4: æ›´æ–° stopMonitoring æ–¹æ³•

æ·»åŠ æ ¡å‡†ç®¡ç†å™¨é‡ç½®ï¼š

```dart
/// åœæ­¢ç›‘æµ‹
void stopMonitoring() {
  if (!_isMonitoring) {
    debugPrint('âš ï¸  PostureProvider: æœªåœ¨ç›‘æµ‹ä¸­ï¼Œè·³è¿‡åœæ­¢');
    return;
  }

  debugPrint('ğŸ›‘ PostureProvider: åœæ­¢ç›‘æµ‹...');
  _isMonitoring = false;

  // å–æ¶ˆè®¢é˜…
  _poseSubscription?.cancel();
  _poseSubscription = null;

  // æ¸…ç©ºæ•°æ®
  _currentPoses = [];
  _currentAnalysis = null;

  // é‡ç½®æ ¡å‡†ç®¡ç†å™¨
  _calibrationManager.reset();

  notifyListeners();

  debugPrint('âœ… PostureProvider: å§¿æ€ç›‘æµ‹å·²åœæ­¢');
}
```

### Step 5: æ›´æ–° dispose æ–¹æ³•

æ·»åŠ èµ„æºé‡Šæ”¾ï¼š

```dart
@override
void dispose() {
  stopMonitoring();
  _cameraController?.dispose();
  _mlkitService.dispose();
  _calibrationManager.dispose();  // æ–°å¢
  super.dispose();
}
```

### Step 6: è¿è¡Œæµ‹è¯•éªŒè¯

```bash
flutter analyze lib/providers/posture_provider.dart
```
é¢„æœŸ: æ— é”™è¯¯

### Step 7: æäº¤

```bash
git add lib/providers/posture_provider.dart
git commit -m "feat: PostureProvider é›†æˆæ ¡å‡†çŠ¶æ€ç®¡ç†å™¨

- æ·»åŠ  CalibrationStateManager å®ä¾‹å’Œè®¿é—®å™¨
- åœ¨å§¿æ€æµä¸­æ›´æ–°æ ¡å‡†çŠ¶æ€
- å¯åŠ¨/åœæ­¢ç›‘æµ‹æ—¶é‡ç½®æ ¡å‡†çŠ¶æ€
- æ·»åŠ èµ„æºé‡Šæ”¾é€»è¾‘"
```

---

## Task 5: å®ç° UI å››æ€åé¦ˆç³»ç»Ÿ

**ç›®æ ‡:** æ›´æ–°æ ¡å‡†ç•Œé¢å®ç°å››çº§åé¦ˆå’Œæ™ºèƒ½é—¨æŒ‰é’®ã€‚

**Files:**
- Modify: `/Users/Zhuanz/Documents/01_SmartPen/smartpen-project/frontend/lib/screens/home_screen.dart`

### Step 1: æ·»åŠ å›¾æ ‡æ˜ å°„æ–¹æ³•

åœ¨ `_HomeScreenState` ç±»ä¸­æ·»åŠ è¾…åŠ©æ–¹æ³•ï¼š

```dart
/// æ ¹æ®æ ¡å‡†çŠ¶æ€è·å–å›¾æ ‡
IconData _getStateIcon(CalibrationState state) {
  switch (state) {
    case CalibrationState.noFace:
      return Icons.face_outlined;
    case CalibrationState.badPosture:
      return Icons.accessibility_new;
    case CalibrationState.noHands:
      return Icons.back_hand_outlined;
    case CalibrationState.aligned:
      return Icons.check_circle;
  }
}
```

### Step 2: æ›´æ–° _buildCalibrationInterface æ–¹æ³•

å®Œå…¨æ›¿æ¢ç°æœ‰çš„ `_buildCalibrationInterface()` å®ç°ï¼š

```dart
/// ========== æ ¡å‡†ç•Œé¢ - å…¨å±ç›¸æœºé¢„è§ˆï¼ˆæ›´æ–°ç‰ˆï¼‰ ==========
Widget _buildCalibrationInterface() {
  return Consumer<PostureProvider>(
    builder: (context, postureProvider, child) {
      final calibrationState = postureProvider.calibrationState;
      final message = postureProvider.calibrationMessage;
      final color = postureProvider.calibrationColor;
      final isReady = postureProvider.isReadyForPractice;

      debugPrint('ğŸ¨ UI: state=$calibrationState, color=$color, ready=$isReady');

      return Container(
        color: Colors.black,
        child: Stack(
          children: [
            // å…¨å±ç›¸æœºé¢„è§ˆ
            if (postureProvider.cameraController?.controller != null)
              CameraPreview(postureProvider.cameraController!.controller!),

            // é¡¶éƒ¨æç¤ºæ 
            Positioned(
              top: 0,
              left: 0,
              right: 0,
              child: Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                    colors: [
                      Colors.black.withOpacity(0.7),
                      Colors.transparent,
                    ],
                  ),
                ),
                child: const Column(
                  children: [
                    Text(
                      'å§¿æ€æ ¡å‡†',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 20,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    SizedBox(height: 8),
                    Text(
                      'è¯·è°ƒæ•´åå§¿ï¼Œä¿æŒå¤´éƒ¨åœ¨ç”»é¢ä¸­å¤®',
                      style: TextStyle(color: Colors.white70),
                    ),
                  ],
                ),
              ),
            ),

            // ========== æ ¸å¿ƒæ›´æ–°ï¼šå››çº§åé¦ˆçŠ¶æ€æŒ‡ç¤ºå™¨ ==========
            Positioned(
              right: 16,
              top: 80,
              child: Column(
                children: [
                  // çŠ¶æ€åœ†åœˆ
                  AnimatedContainer(
                    duration: const Duration(milliseconds: 300),
                    curve: Curves.easeInOut,
                    child: CircleAvatar(
                      radius: 40,
                      backgroundColor: color,
                      child: Icon(
                        _getStateIcon(calibrationState),
                        color: Colors.white,
                        size: 40,
                      ),
                    ),
                  ),
                  const SizedBox(height: 12),
                  // çŠ¶æ€æ–‡æœ¬
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 8,
                    ),
                    decoration: BoxDecoration(
                      color: color.withOpacity(0.9),
                      borderRadius: BorderRadius.circular(20),
                    ),
                    child: Text(
                      message,
                      style: const TextStyle(
                        color: Colors.white,
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                ],
              ),
            ),

            // ========== æ ¸å¿ƒæ›´æ–°ï¼šæ™ºèƒ½é—¨æŒ‰é’® ==========
            Positioned(
              bottom: 50,
              left: 0,
              right: 0,
              child: Center(
                child: AnimatedOpacity(
                  duration: const Duration(milliseconds: 300),
                  opacity: 1.0,
                  child: ElevatedButton(
                    // æ ¸å¿ƒäºŒæ¡ä»¶ï¼šåªæœ‰åœ¨ aligned çŠ¶æ€æŒç»­1ç§’åæ‰å¯ç”¨
                    onPressed: isReady
                        ? () {
                            setState(() {
                              _isCalibrating = false;
                            });
                            debugPrint('âœ… ç”¨æˆ·ç‚¹å‡»"å¼€å§‹ç»ƒä¹ "');
                          }
                        : null,  // null = ç¦ç”¨çŠ¶æ€
                    style: ElevatedButton.styleFrom(
                      backgroundColor: isReady ? Colors.green : Colors.grey,
                      disabledBackgroundColor: Colors.grey.shade700,
                      padding: const EdgeInsets.symmetric(
                        horizontal: 48,
                        vertical: 16,
                      ),
                      elevation: isReady ? 8 : 0,
                    ),
                    child: Row(
                      mainAxisSize: MainAxisSize.min,
                      children: [
                        if (isReady) ...[
                          const Icon(Icons.check_circle, size: 24),
                          const SizedBox(width: 8),
                        ] else ...[
                          const Icon(Icons.lock, size: 24),
                          const SizedBox(width: 8),
                        ],
                        Text(
                          isReady ? 'å¼€å§‹ç»ƒä¹ ' : 'æ ¡å‡†ä¸­...',
                          style: const TextStyle(fontSize: 18),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),

            // ========== è°ƒè¯•ä¿¡æ¯é¢æ¿ï¼ˆä»… Debug æ¨¡å¼ï¼‰ ==========
            if (kDebugMode)
              Positioned(
                left: 16,
                bottom: 50,
                child: Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: Colors.black.withOpacity(0.7),
                    borderRadius: BorderRadius.circular(8),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        'State: $calibrationState',
                        style: const TextStyle(
                          color: Colors.white,
                          fontSize: 12,
                          fontFamily: 'monospace',
                        ),
                      ),
                      Text(
                        'Ready: $isReady',
                        style: TextStyle(
                          color: isReady ? Colors.green : Colors.orange,
                          fontSize: 12,
                          fontFamily: 'monospace',
                        ),
                      ),
                      if (postureProvider.currentAnalysis != null)
                        Text(
                          'Hands: ${postureProvider.currentAnalysis!.hasVisibleHands}, '
                          'Face: ${postureProvider.currentAnalysis!.isFaceDetected}',
                          style: const TextStyle(
                            color: Colors.white70,
                            fontSize: 10,
                            fontFamily: 'monospace',
                          ),
                        ),
                    ],
                  ),
                ),
              ),
          ],
        ),
      );
    },
  );
}
```

### Step 3: æ›´æ–° _buildStatusIndicator æ–¹æ³•

ä¿®æ”¹çŠ¶æ€æŒ‡ç¤ºå™¨æ”¯æŒå››æ€æ˜¾ç¤ºï¼š

```dart
/// ========== çŠ¶æ€æŒ‡ç¤ºå™¨ - å³ä¸Šè§’å››æ€æ˜¾ç¤º ==========
Widget _buildStatusIndicator() {
  return Positioned(
    top: 16,
    right: 16,
    child: Consumer<PostureProvider>(
      builder: (context, postureProvider, child) {
        // åªåœ¨ç›‘æµ‹ä¸­æ—¶æ˜¾ç¤º
        if (!postureProvider.isMonitoring) {
          return const SizedBox.shrink();
        }

        final color = postureProvider.calibrationColor;
        final icon = _getStateIcon(postureProvider.calibrationState);

        return AnimatedContainer(
          duration: const Duration(milliseconds: 300),
          child: CircleAvatar(
            radius: 20,
            backgroundColor: color,
            child: Icon(
              icon,
              color: Colors.white,
              size: 24,
            ),
          ),
        );
      },
    ),
  );
}
```

### Step 4: æ·»åŠ å¿…è¦çš„å¯¼å…¥

ç¡®ä¿æ–‡ä»¶é¡¶éƒ¨æœ‰æ‰€æœ‰å¿…è¦çš„å¯¼å…¥ï¼š

```dart
import 'package:flutter/foundation.dart';
import '../services/posture_data.dart';  // æ·»åŠ è¿™è¡Œ
```

### Step 5: è¿è¡Œæµ‹è¯•éªŒè¯

```bash
flutter analyze lib/screens/home_screen.dart
```
é¢„æœŸ: æ— é”™è¯¯

### Step 6: æäº¤

```bash
git add lib/screens/home_screen.dart
git commit -m "feat: å®ç°å››çº§åé¦ˆç³»ç»Ÿå’Œæ™ºèƒ½é—¨æŒ‰é’®

- æ·»åŠ çŠ¶æ€å›¾æ ‡æ˜ å°„ï¼ˆäººè„¸/å§¿æ€/æ‰‹éƒ¨/å¯¹é½ï¼‰
- æ›´æ–°æ ¡å‡†ç•Œé¢ï¼šå››æ€åœ†åœˆ + çŠ¶æ€æ–‡æœ¬ + åŠ¨ç”»è¿‡æ¸¡
- å®ç°æ™ºèƒ½é—¨æŒ‰é’®ï¼šé»˜è®¤ç¦ç”¨ï¼Œaligned æŒç»­ 1 ç§’åå¯ç”¨
- æ›´æ–°å³ä¸Šè§’çŠ¶æ€æŒ‡ç¤ºå™¨æ”¯æŒå››æ€æ˜¾ç¤º
- æ·»åŠ è°ƒè¯•ä¿¡æ¯é¢æ¿ï¼ˆDebug æ¨¡å¼ï¼‰"
```

---

## Task 6: æ‰‹åŠ¨æµ‹è¯•éªŒè¯

**ç›®æ ‡:** åœ¨çœŸå®è®¾å¤‡ä¸ŠéªŒè¯å®Œæ•´æµç¨‹ã€‚

### Step 1: æ„å»ºå¹¶å®‰è£…åˆ°è®¾å¤‡

```bash
cd /Users/Zhuanz/Documents/01_SmartPen/smartpen-project/frontend
flutter run -d V1962A
```

### Step 2: æµ‹è¯•å››ç§çŠ¶æ€

**åœºæ™¯ 1ï¼šæ— äººè„¸ï¼ˆCase Aï¼‰**
1. å¯åŠ¨å§¿æ€ç›‘æµ‹
2. ç”¨æ‰‹é®æŒ¡æ‘„åƒå¤´
3. éªŒè¯ï¼šçº¢è‰²åœ†åœˆ + "No face detected" + æŒ‰é’®æ˜¾ç¤º"æ ¡å‡†ä¸­..."ï¼ˆç¦ç”¨ï¼‰

**åœºæ™¯ 2ï¼šå§¿æ€ä¸ä½³ï¼ˆCase Bï¼‰**
1. æ£€æµ‹åˆ°äººè„¸
2. æ•…æ„æ­ªå¤´æˆ–é©¼èƒŒ
3. éªŒè¯ï¼šæ©™è‰²åœ†åœˆ + "Sit up straight" + æŒ‰é’®ç¦ç”¨

**åœºæ™¯ 3ï¼šæ— æ‰‹éƒ¨ï¼ˆCase Cï¼‰**
1. å§¿æ€æ­£ç¡®
2. å°†æ‰‹è—åœ¨æ¡Œä¸‹
3. éªŒè¯ï¼šæ©™è‰²åœ†åœˆ + "Show your hand" + æŒ‰é’®ç¦ç”¨

**åœºæ™¯ 4ï¼šå¯¹é½å®Œæˆï¼ˆCase Dï¼‰**
1. å§¿æ€æ­£ç¡®
2. æ‰‹éƒ¨å¯è§
3. éªŒè¯ï¼šç­‰å¾… 1 ç§’åç»¿è‰²åœ†åœˆ + "Perfect!" + æŒ‰é’®å˜ä¸ºç»¿è‰²å¯ç‚¹å‡»

### Step 3: æµ‹è¯•æ‰‹éƒ¨ç¼“å†²æœŸ

1. å§¿æ€æ­£ç¡® + æ‰‹éƒ¨å¯è§
2. ç­‰å¾… 1 ç§’ï¼ŒæŒ‰é’®å¯ç”¨
3. çŸ­æš‚ç§»å¼€æ‰‹éƒ¨ï¼ˆ< 1 ç§’ï¼‰
4. éªŒè¯ï¼šæŒ‰é’®ä¿æŒå¯ç”¨çŠ¶æ€
5. ç§»å¼€æ‰‹éƒ¨ï¼ˆ> 1 ç§’ï¼‰
6. éªŒè¯ï¼šæŒ‰é’®ç¦ç”¨ï¼Œæ˜¾ç¤º "Show your hand"

### Step 4: æ€§èƒ½ç›‘æ§

ä½¿ç”¨ Flutter DevTools è§‚å¯Ÿï¼š
- FPS æ˜¯å¦ç¨³å®šåœ¨ 9-11
- å†…å­˜å¢é•¿æ˜¯å¦æ­£å¸¸
- CPU å ç”¨æ˜¯å¦åˆç†

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] å››ç§çŠ¶æ€æ­£ç¡®æ˜¾ç¤ºï¼ˆçº¢/æ©™/æ©™/ç»¿ï¼‰
- [ ] çŠ¶æ€æ–‡æœ¬æ­£ç¡®æ˜¾ç¤ºï¼ˆ"No face detected" / "Sit up straight" / "Show your hand" / "Perfect!"ï¼‰
- [ ] æ™ºèƒ½é—¨æŒ‰é’®é»˜è®¤ç¦ç”¨ï¼ˆç°è‰²ï¼‰
- [ ] aligned çŠ¶æ€æŒç»­ 1 ç§’åæŒ‰é’®å¯ç”¨ï¼ˆç»¿è‰²ï¼‰
- [ ] æ‰‹éƒ¨çŸ­æš‚æ¶ˆå¤±ï¼ˆ< 1 ç§’ï¼‰ä¸è§¦å‘è­¦å‘Š
- [ ] è°ƒè¯•é¢æ¿æ˜¾ç¤ºæ­£ç¡®çŠ¶æ€ä¿¡æ¯

### æ€§èƒ½éªŒæ”¶

- [ ] FPS: 9-11ï¼ˆä¸ä¹‹å‰ä¿æŒä¸€è‡´ï¼‰
- [ ] å†…å­˜å¢é•¿: < 5MBï¼ˆä»…å¢åŠ çŠ¶æ€ç®¡ç†å™¨ï¼‰
- [ ] CPU å ç”¨: < 30%ï¼ˆä¸­ç«¯è®¾å¤‡ï¼‰
- [ ] çŠ¶æ€åˆ‡æ¢å»¶è¿Ÿ: < 100ms

### ä»£ç è´¨é‡

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ— æ˜æ˜¾å†…å­˜æ³„æ¼
- [ ] ä»£ç ç¬¦åˆ Flutter è§„èŒƒ
- [ ] è°ƒè¯•æ—¥å¿—æ¸…æ™°å®Œæ•´

---

## åç»­æ­¥éª¤

å®Œæˆæ­¤è®¡åˆ’åï¼Œå¯ä»¥è€ƒè™‘ä»¥ä¸‹å¢å¼ºï¼š

1. **æœ¬åœ°åŒ–æ”¯æŒ**ï¼šæ·»åŠ ä¸­è‹±æ–‡åˆ‡æ¢
2. **è¯­éŸ³æç¤º**ï¼šTTS æœ—è¯»çŠ¶æ€å˜åŒ–
3. **éœ‡åŠ¨åé¦ˆ**ï¼šæŒ‰é’®å¯ç”¨æ—¶éœ‡åŠ¨æé†’
4. **è®¾ç½®é€‰é¡¹**ï¼šå…è®¸ç”¨æˆ·è°ƒæ•´ç¨³å®šæ€§é˜ˆå€¼ï¼ˆ0.5-2 ç§’ï¼‰
5. **æ•°æ®ç»Ÿè®¡**ï¼šè®°å½•æ ¡å‡†æ—¶é—´ã€æˆåŠŸç‡ç­‰æŒ‡æ ‡
