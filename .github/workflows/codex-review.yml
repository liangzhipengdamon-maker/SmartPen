# Codex Deep Review for Pull Requests
# åœ¨ PR åˆ›å»ºæˆ–æ›´æ–°æ—¶è‡ªåŠ¨è¿è¡Œæ·±åº¦ä»£ç å®¡æŸ¥

name: Codex Deep Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  codex-review:
    name: Codex Deep Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Codex CLI
        run: |
          # TODO: æ›¿æ¢ä¸ºå®žé™…çš„ Codex CLI å®‰è£…å‘½ä»¤
          # ä¾‹å¦‚: pip install codex-cli
          # æˆ–è€…ä»Žç§æœ‰ä»“åº“å®‰è£…
          echo "Installing Codex CLI..."
          # pip install codex-cli

      - name: Get changed files
        id: changed-files
        run: |
          # èŽ·å– PR ä¸­å˜æ›´çš„ Python å’Œ Dart æ–‡ä»¶
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | grep -E '\.(py|dart)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No Python/Dart files to review"
            echo "files_changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "files_changed=true" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Run Codex Deep Review
        if: steps.changed-files.outputs.files_changed == 'true'
        run: |
          # TODO: æ›¿æ¢ä¸ºå®žé™…çš„ Codex å®¡æŸ¥å‘½ä»¤
          # codex review \
          #   --mode deep \
          #   --files $(cat changed_files.txt | tr '\n' ',') \
          #   --output codex-review.md \
          #   --format markdown \
          #   --include architecture,security,complexity,testing,performance

          echo "Running Codex deep review..."
          # åˆ›å»ºç¤ºä¾‹å®¡æŸ¥æŠ¥å‘Š
          cat > codex-review.md << 'EOF'
          ## ðŸ¤– Codex Deep Review Report

          ### ðŸ“Š Review Summary
          - **Files Reviewed**: $(cat changed_files.txt | wc -l)
          - **Issues Found**: 0
          - **Severity**: None

          ### âœ… Review Status
          All checks passed! No critical issues found.

          ---
          *This review was automatically generated by Codex*
          EOF

      - name: Post review as PR comment
        if: steps.changed-files.outputs.files_changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // è¯»å–å®¡æŸ¥æŠ¥å‘Š
            let report = '';
            try {
              report = fs.readFileSync('codex-review.md', 'utf8');
            } catch (error) {
              report = '## ðŸ¤– Codex Review\n\nNo review report generated.';
            }

            // æŸ¥æ‰¾çŽ°æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // æŸ¥æ‰¾ Codex æœºå™¨äººå‘çš„è¯„è®º
            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ¤– Codex Deep Review Report')
            );

            if (botComment) {
              // æ›´æ–°çŽ°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

      - name: Check for critical issues
        if: steps.changed-files.outputs.files_changed == 'true'
        run: |
          # å¦‚æžœæœ‰ä¸¥é‡é—®é¢˜ï¼Œè¿”å›žé”™è¯¯
          if grep -q "### Critical" codex-review.md 2>/dev/null; then
            echo "Critical issues found - failing check"
            exit 1
          fi
          echo "No critical issues - review passed"
